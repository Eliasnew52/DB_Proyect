{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
Crear Venta
{% endblock title %}

{% block content %}
<div class="col-lg-8 col-sm-12 tabs_wrapper">
    <div class="page-header">
        <div class="page-title">
            <h4>Crear venta</h4>
            <h6>Gestiona tus compras</h6>
        </div>
    </div>
    <div class="col-lg-12 mb-3">
        <div class="w-100">
            <label for="product-search">Buscar productos</label>
            <input type="search" name="search" placeholder="Buscar productos por nombre, marca o categoría o precio" id="product-search" class="form-control">
        </div>
    </div>
    <!-- Filtro de Categorías de los productos -->
    <ul class="tabs owl-carousel owl-theme owl-product border-0">
        <li id="all" class="active">
            <a class="product-details">
                <!-- <img src="{{ category.imagen.url }}" alt="{{ category.imagen.url }}"
                    style="width: 47px; height: 47px;" /> -->
                <h6>Todos</h6>
            </a>
        </li>
        {% for category in categories %}
        <li id="{{ category.nombre }}">
            <a class="product-details">
                <img src="{{ category.imagen.url }}" alt="{{ category.imagen.url }}"
                    style="width: 47px; height: 47px;" />
                <h6>{{ category.nombre }}</h6>
            </a>
        </li>
        {% endfor %}
    </ul>
    <!-- Productos -->
    <div class="tabs_container">
        <div id="result-container">

        </div>
        <div class="tab_content active" data-tab="all">
            <div class="row">
                {% for product in products %}
                <div class="col-lg-3 col-sm-6 d-flex">
                    <div class="productset flex-fill" data-product-id="{{ product.id }}" data-product-stock="{{ product.stock }}"
                        data-image-url="{% if product.imagen %}{{ product.imagen.url }} {% else %} {% static 'assets/img/product/noimage.png' %} {% endif %}"
                        data-product-name="{{ product.nombre }}" data-product-price="{{ product.precio_venta }}" data-product-category="{{ product.categoria }}">
                        <div class="productsetimg">
                            {% if product.imagen %}
                            <img src="{{ product.imagen.url }}" alt="img" style="width: 208px; height: 208px;" />
                            {% else %}
                            <img src="{% static 'assets/img/product/noimage.png' %}" alt="img"
                                style="width: 208px; height: 208px;" />
                            {% endif %}
                            <h6>C${{ product.precio_venta }}</h6>
                            
                            {% if product.stock <= product.stock_minimo %}
                            <span class="badge bg-danger low-stock">Stock bajo</span>
                            {% endif %}
                            <div class="check-product">
                                <i class="fa fa-check"></i>
                            </div>
                            <span class="badge bg-secondary brand">{{ product.marca }}</span>
                        </div>
                        <div class="productsetcontent">
                            <div class="d-flex align-items-center gap-1">
                                <i class="fe fe-tag"></i>
                                <h5>{{ product.categoria }}</h5>
                            </div>                            
                            <h4>{{ product.nombre }}</h4>
                            <h5>Stock: {{ product.stock }}</h5>
                            <div class="align-self-end">
                                <a href="{% if product.imagen %}{{ product.imagen.url }} {% else %} {% static 'assets/img/product/noimage.png' %} {% endif %}" class="btn btn-outline-secondary rounded-circle image-popup-desc view-product" data-glightbox="title: My title; description: this is the slide description">
                                    <i class="fe fe-eye" role="button"></i>
                                </a>
                                <button 
                                    class="btn btn-primary rounded-circle add-product"
                                    data-product-id="{{ product.id }}" data-product-stock="{{ product.stock }}"
                                    data-image-url="{% if product.imagen %}{{ product.imagen.url }} {% else %} {% static 'assets/img/product/noimage.png' %} {% endif %}"
                                    data-product-name="{{ product.nombre }}" data-product-price="{{ product.precio_venta }}" data-product-category="{{ product.categoria }}"    
                                >
                                    <i class="fe fe-plus" role="button"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% for category in categories %}
        <div class="tab_content" data-tab="{{ category.nombre }}">
            <div class="row">
                {% for product in products %}
                {% if product.categoria == category %}
                <div class="col-lg-3 col-sm-6 d-flex">
                    <div class="productset flex-fill" data-product-id="{{ product.id }}" data-product-stock="{{ product.stock }}"
                        data-image-url="{% if product.imagen %}{{ product.imagen.url }} {% else %} {% static 'assets/img/product/noimage.png' %} {% endif %}"
                        data-product-name="{{ product.nombre }}" data-product-price="{{ product.precio_venta }}" data-product-category="{{ product.categoria }}">
                        <div class="productsetimg">
                            {% if product.imagen %}
                            <img src="{{ product.imagen.url }}" alt="img" style="width:  208px; height:  208px;" />
                            {% else %}
                            <img src="{% static 'assets/img/product/noimage.png' %}" alt="img"
                                style="width: 208px; height: 208px;" />
                            {% endif %}
                            <h6>C${{ product.precio_venta }}</h6>
                            {% if product.stock <= product.stock_minimo %}
                            <span class="badge bg-danger low-stock">Stock bajo</span>
                            {% endif %}
                            <div class="check-product">
                                <i class="fa fa-check"></i>
                            </div>
                            <span class="badge bg-secondary brand">{{ product.marca }}</span>
                        </div>
                        <div class="productsetcontent">
                            <div class="d-flex align-items-center gap-1">
                                <i class="fe fe-tag"></i>
                                <h5>{{ category.nombre }}</h5>
                            </div>
                            <h4>{{ product.nombre }}</h4>
                            <h5>Stock: {{ product.stock }}</h5>
                            <div class="align-self-end">
                                <button class="btn btn-outline-secondary rounded-circle image-popup-desc view-product" data-title="Title 01" data-description="Lorem ipsum dolor sit amet, consectetuer adipiscing elit">
                                    <i class="fe fe-eye" role="button"></i>
                                </button>
                                <button 
                                    class="btn btn-primary rounded-circle add-product"
                                    data-product-id="{{ product.id }}" data-product-stock="{{ product.stock }}"
                                    data-image-url="{% if product.imagen %}{{ product.imagen.url }} {% else %} {% static 'assets/img/product/noimage.png' %} {% endif %}"
                                    data-product-name="{{ product.nombre }}" data-product-price="{{ product.precio_venta }}" data-product-category="{{ product.categoria }}"    
                                >
                                    <i class="fe fe-plus" role="button"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- Detalles de la venta -->
<div class="col-lg-4 col-sm-12">
    <!-- Formulario de venta -->
    <div class="card card-order">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row">
                    <div class="col-lg-12">
                        <div class="select-split">
                            <div class="w-100">
                                <label for="{{ form.cliente.id_for_label }}">Cliente <span
                                        class="text-danger">*</span></label>
                                {% render_field form.cliente class="form-control form-control-sm client-select" %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="select-split">
                            <div class="select-group w-100">
                                <label for="{{ form.forma_de_pago.id_for_label }}">Forma de pago <span
                                        class="text-danger">*</span></label>
                                {% render_field form.forma_de_pago class="form-control form-control-sm select" %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="select-split">
                            <div class="select-group w-100">
                                <label for="{{ form.estado.id_for_label }}">Estado <span
                                        class="text-danger">*</span></label>
                                {% render_field form.estado class="form-control form-control-sm select" %}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Preview de productos seleccionados -->
                <div class="card-body p-0 pt-1">
                    <div class="totalitem">
                        <h4>Total de artículos: <span id="total-items">0</span></h4>
                        <a href="javascript:void(0);" id="clear-all">
                            <img src="{% static 'assets/img/icons/delete-2.svg' %}" alt="img" />
                        </a>
                    </div>
                    <div class="product-table" id="selected-products">
                        
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="select-group">
                            <label for="{{ form.tipo_descuento.id_for_label }}">Tipo de descuento</label>
                            {% render_field form.tipo_descuento class="form-control select" id="discount-type" %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="select-group">
                            <label for="{{ form.valor_descuento.id_for_label }}">Valor del descuento</label>
                            {% render_field form.valor_descuento class="form-control" id="discount-value" inputmode="decimal" pattern="/[^\d.]/g" %}
                        </div>
                    </div>
                </div>

                <!-- Total de venta -->
                <div class="pt-0">
                    <div class="setvalue">
                        <ul>
                            <li>
                                <h5>Subtotal</h5>
                                <h6 id="subtotal">C$0.00</h6>
                            </li>
                            <li>
                                <h5>Descuento <span id="discount-type-text">(0%)</span></h5>
                                <h6 id="discount">C$0.00</h6>
                            </li>
                            <li class="total-value">
                                <h5>Total</h5>
                                <h6 id="total">C$0.00</h6>
                            </li>
                        </ul>
                    </div>
                    <!-- Botón para crear venta -->
                    <button type="submit" class="btn btn-totallabel w-100 justify-content-center">
                        <h5>Pagar</h5>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="edit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Pedido</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-6 col-sm-12 col-12">
                        <div class="form-group">
                            <label>Impuesto</label>
                            <div class="input-group">
                                <input type="text" />
                                <a class="scanner-set input-group-text">%</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12 col-12">
                        <div class="form-group">
                            <label>Descuento</label>
                            <input type="text" value="20" />
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <a class="btn btn-submit me-2">Guardar</a>
                    <a class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        const selectedProductsContainer = document.getElementById('selected-products');
        const totalItemsElement = document.getElementById('total-items');
        const discountTypeTextElement = document.getElementById('discount-type-text');
        const discountElement = document.getElementById('discount');
        const discountInput = document.getElementById('discount-value');
        const subtotalElement = document.getElementById('subtotal');
        const totalElement = document.getElementById('total');
        const clearAllButton = document.getElementById('clear-all');
        const discountType = document.getElementById('discount-type');
        const quantityField = document.getElementById('quantity-field');

        const tabElement = document.querySelector('.tab_content');

        let selectedProducts = [];
        window.selectedProducts = selectedProducts;
        window.updateSelectedProducts = updateSelectedProducts;

        selectedProductsContainer.innerHTML = `
            <div class="d-flex flex-column justify-content-center align-items-center gap-0 h-100">
                <i class="fe fe-shopping-cart" style="font-size: 32px;"></i>
                <span class="fw-bold">
                    El carrito está vacío
                </span>
            </div>
        `;

        $('#discount-type').on('change', function(e) {
            document.getElementById('discount-value').value = '';
            updateSelectedProducts();
        });

        function toggleDiscountInput() {
            const subtotal = parseFloat(subtotalElement.textContent.replace('C$', '').trim()) || 0;
            if (subtotal === 0) {
                discountInput.value = '';
                discountInput.disabled = true;
            } else {
                discountInput.disabled = false;
            }
        }
    
        discountInput.addEventListener('input', function () {
            const type = discountType.value; 
            let rawValue = this.value; 
            let newValue = rawValue.replace(/[^\d.]/g, '');
    
            if (newValue.startsWith('.')) {
                newValue = '0' + newValue;
            }
    
            const parts = newValue.split('.');
            if (parts.length > 1) {
                parts[1] = parts[1].slice(0, 2);
                newValue = parts.join('.');
            }
    
            if (type === 'POR') {
                const numericValue = parseFloat(newValue) || 0;
                if (numericValue > 100) {
                    newValue = newValue.slice(0, -1);
                }
            } else if (type === 'FIX') {
                const subtotal = parseFloat(subtotalElement.textContent.replace('C$', '').trim()) || 0;
                const numericValue = parseFloat(newValue) || 0;
    
                if (numericValue > subtotal) {
                    newValue = newValue.slice(0, -1);
                }
            }
    
            this.value = newValue;
        });
    
        discountInput.addEventListener('keypress', function (e) {
            const key = e.key;
            const currentValue = this.value;
            const hasDecimal = currentValue.includes('.');
    
            if (!/\d/.test(key) && key !== '.' && key !== 'Backspace') {
                e.preventDefault();
            }
    
            if (key === '.' && hasDecimal) {
                e.preventDefault();
            }
        });

        document.querySelectorAll('.add-product').forEach(function (productElement) {
            productElement.addEventListener('click', function () {
                const productId = productElement.getAttribute('data-product-id');
                const productName = productElement.getAttribute('data-product-name');
                const productImage = productElement.getAttribute('data-image-url');
                const productPrice = parseFloat(productElement.getAttribute('data-product-price'));
                const productStock = parseFloat(productElement.getAttribute('data-product-stock'));

                const existingProduct = selectedProducts.find(product => product.id === productId);
                let productQuantity = 1;
                if (existingProduct) {
                    if (existingProduct.quantity === productStock) return;
                    existingProduct.quantity += 1;
                    productQuantity = existingProduct.quantity;
                } else {
                    selectedProducts.push({
                        id: productId,
                        name: productName,
                        price: productPrice,
                        image: productImage,
                        quantity: 1,
                        stock: productStock,
                    });
                    productElement.classList.add('active');
                }
                document.querySelector('.productset .check-product').textContent = productQuantity;

                updateSelectedProducts();
            });
        });

        clearAllButton.addEventListener('click', function () {
            selectedProducts = [];
            discountInput.value = '0';
            updateSelectedProducts();
            document.querySelectorAll('.add-product').forEach(function (productElement) {
                productElement.classList.remove('active');
            });
        });

        function updateSelectedProducts() {
            selectedProductsContainer.innerHTML = '';
            let totalItems = 0;
            let subtotal = 0;

            window.selectedProducts = selectedProducts;
            if (selectedProducts.length === 0) {
                document.getElementById('product-search').value = "";
                selectedProductsContainer.innerHTML = `
                    <div class="d-flex flex-column justify-content-center align-items-center gap-0 h-100">
                        <i class="fe fe-shopping-cart" style="font-size: 32px;"></i>
                        <span class="fw-bold">
                            El carrito está vacío
                        </span>
                    </div>
                `;
            }

            selectedProducts.forEach(function (product, index) {
                totalItems += product.quantity;
                subtotal += product.price * product.quantity;

                const productElement = document.createElement('ul');
                productElement.classList.add('product-lists');
                productElement.innerHTML = `
                    <li class="w-100 d-flex justify-content-between">
                        <div class="d-flex align-items-center gap-2">
                            <div class="productimgs">
                                <img src="${product.image}" alt="img" style="width: 47px; height: 47px;" />
                            </div>
                            <div class="productcontet">
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold">
                                    ${product.name}
                                    </span>
                                    <a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#edit" class="ms-2">
                                        <img src="{% static 'assets/img/icons/edit-5.svg' %}" style="opacity: 1!important" alt="img" />
                                    </a>
                                    
                                </div>
                                
                                <span class="text-muted">C$${(product.price).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="increment-decrement">
                                <div class="input-groups">
                                    <input type="button" value="-" class="button-minus dec button" data-product-id="${product.id}" />
                                    <input type="text" name="child" value="${product.quantity}" class="quantity-field" readonly />
                                    <input type="button" value="+" class="button-plus inc button" data-product-id="${product.id}" />
                                </div>
                            </div>
                            <i class="fe fe-trash-2 ms-2 text-danger fs-5" data-product-id="${product.id}" data-action="remove" role="button"></i>
                        </div>

                    </li>
                `;

                selectedProductsContainer.appendChild(productElement);
            });

            const discountType = document.getElementById('discount-type').value || '';
            const discountValue = Number(document.getElementById('discount-value').value) || 0;
            const calculatedDiscount = discountType === 'POR' 
                ? subtotal * (discountValue / 100) 
                : discountValue;
            const total = subtotal - calculatedDiscount;

            totalItemsElement.textContent = totalItems;
            subtotalElement.textContent = `C$${subtotal.toFixed(2)}`;
            discountElement.textContent = `C$${calculatedDiscount.toFixed(2)}`;
            discountTypeTextElement.textContent = `${  discountType === 'POR' ? `(${discountValue}%)` : '' }`;
            totalElement.textContent = `C$${total.toFixed(2)}`;

            document.querySelectorAll('[data-action="remove"]').forEach(function (removeButton) {
                removeButton.addEventListener('click', function () {
                    const productId = removeButton.getAttribute('data-product-id');
                    selectedProducts = selectedProducts.filter(product => product.id !== productId);
                    updateSelectedProducts();
                    document.querySelector(`.add-product[data-product-id="${productId}"]`).classList.remove('active');
                });
            });

            document.querySelectorAll('.button-minus').forEach(function (minusButton) {
                minusButton.addEventListener('click', function () {
                    const productId = minusButton.getAttribute('data-product-id');
                    const product = selectedProducts.find(product => product.id === productId);
                    if (product.quantity > 1) {
                        product.quantity -= 1;
                        document.querySelector(`.productset[data-product-id="${productId}"] .check-product`).textContent = product.quantity;
                    } else {
                        selectedProducts = selectedProducts.filter(product => product.id !== productId);
                        document.querySelector(`.productset[data-product-id="${productId}"]`).classList.remove('active');
                    }
                    updateSelectedProducts();
                });
            });

            
            document.querySelectorAll('.button-plus').forEach(function (plusButton) {
                plusButton.addEventListener('click', function () {
                    const productId = plusButton.getAttribute('data-product-id');
                    const product = selectedProducts.find(product => product.id === productId);
                    if (product.quantity === product.stock) return;
                    product.quantity += 1;
                    document.querySelector(`.productset[data-product-id="${productId}"] .check-product`).textContent = product.quantity;
                    updateSelectedProducts();
                });
            });

            document.querySelectorAll('#quantity-field').forEach((q) => {
                const productQuantity = parseFloat(q.getAttribute('data-product-quantity'));
                const productStock = q.getAttribute('data-product-stock');
                const productId = q.getAttribute('data-product-id');

                q.addEventListener('blur', (e) => {
                    if (e.target.value.length === 0) {
                        const existingProduct = selectedProducts.find(p => p.id === productId);
                        q.value = existingProduct.quantity;
                    }
                })

                q.addEventListener('input', (e) => {
                    const value = e.target.value;
                    const existingProduct = selectedProducts.find(p => p.id === productId);

                    if (!existingProduct) return;

                    if (value.length > productStock.length || parseFloat(value) > parseFloat(productStock)) {
                        const newValue = value.slice(0, -1);
                        q.value = newValue;
                        existingProduct.quantity = newValue;
                    }
                    
                    else if (parseFloat(value) === 0) {
                        q.value = 1;
                        existingProduct.quantity = 1;
                    }

                    else if (value.length > 0) {
                        existingProduct.quantity = parseFloat(value);
                    }
                })
            })

            toggleDiscountInput();
        }

        toggleDiscountInput();
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('product-search');
        const tabs = document.querySelectorAll('ul.tabs li');
        const products = document.querySelectorAll('.productset');
        const resultContainer = document.getElementById('result-container');
    
        searchInput.addEventListener('input', function () {
            filterProducts();
        });
    
        function filterProducts() {
            const query = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('ul.tabs li.active').id;
    
            let visibleProducts = 0;

            products.forEach(product => {
                const productName = product.getAttribute('data-product-name').toLowerCase();
                const productCategory = product.getAttribute('data-product-category');
                
                if (query.length === 0){
                    product.parentElement.classList.remove('product-hidden');
                    return
                }

                if (
                    (activeCategory === 'all' || productCategory === activeCategory) &&
                    productName.includes(query)
                ) {
                    product.parentElement.classList.remove('product-hidden');
                    visibleProducts++;
                } else {
                    product.parentElement.classList.add('product-hidden');
                }
            });

            const noResultMessage = document.createElement('div');
            noResultMessage.classList.add('d-flex', 'flex-column', 'align-items-center', 'gap-0', 'p-3', 'd-none');
            noResultMessage.id = 'no-result-message';

            const icon = document.createElement('i');
            icon.classList.add('fe', 'fe-shopping-cart');
            icon.style.fontSize = '32px';

            const boldText = document.createElement('span');
            boldText.classList.add('fw-bold');
            boldText.textContent = 'No se encontraron productos';

            const mutedText = document.createElement('span');
            mutedText.classList.add('text-muted');
            mutedText.textContent = 'Intenta con otra búsqueda.';

            noResultMessage.appendChild(icon);
            noResultMessage.appendChild(boldText);
            noResultMessage.appendChild(mutedText);

            if (visibleProducts === 0 && query.length > 0) {
                resultContainer.innerHTML = `
                    <div class="d-flex flex-column align-items-center gap-0 p-3" id="no-result-message">
                        <i class="fe fe-shopping-cart" style="font-size: 32px;"></i>
                        <span class="fw-bold">
                            No se encontraron productos
                        </span>
                        <span class="text-muted">
                            Intenta con otra búsqueda.
                        </span>
                    </div>
                `;
            } else {
                resultContainer.innerHTML = ''
            }
        }
    
        filterProducts();
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('.add-product').on("click", function () {
            const productName = $(this).data('product-name')
			toastr.success(`${productName} ha sido agregado al carrito`, "Producto Agregado", {
				showDuration: 500,
                positionClass: "toast-top-right",
                closeButton: true,
                timeOut: 1500
			});
		})
    })
</script>
{% endblock content %}